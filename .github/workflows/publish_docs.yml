name: Generate Documentation and Publish Release

on:
  push:
    branches: ["main"]
    
jobs:
  docs-and-release:
    runs-on: ubuntu-latest
    # Ensures actions don't run on bot commits
    if: ${{ !contains(github.event.head_commit.message, '[gh-bot]') }}
    
    permissions:
      contents: write  # Needed for creating releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Run Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v2
        
      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-recommended texlive-latex-extra

      - name: Replace static table in syn.tex with dynamic results
        run: |
          SYN_TEX="doc/syn.tex"
          RESULTS_TEX="out/results/synth_results.tex"

          if [ ! -f "$RESULTS_TEX" ]; then
            echo "Warning: $RESULTS_TEX not found, skipping table replacement."
            exit 0
          fi

          if [ -f "$SYN_TEX" ]; then
            # 1) Backup original
            cp "$SYN_TEX" "${SYN_TEX}.bak"

            # 2) Remove the old example table lines (from \begin{longtable} to \end{longtable})
            #    We can do a block delete in sed:
            sed -i '/\\begin{longtable}/,/\\end{longtable}/d' "$SYN_TEX"

            # 3) Insert our new table after the \subsection{Area and Gate Count} line, for instance:
            sed -i '/\\subsection{Area and Gate Count}/a \\input{../../out/results/synth_results.tex}' "$SYN_TEX"

            echo "Replaced static table in $SYN_TEX with an \\input statement."
          else
            echo "syn.tex not found at $SYN_TEX; skipping."
          fi

      - name: Build Documentation
        run: |
          # Run 'make docs' which should compile LaTeX
          nix develop --command make docs

      - name: Generate Verilog
        run: nix develop --command make verilog
        
      - name: Collect artifacts for release
        run: |
          mkdir -p release_artifacts
          
          # Copy PDFs from out/doc if present
          if [ -d "out/doc" ] && [ "$(find out/doc -name "*.pdf" -type f | wc -l)" -gt 0 ]; then
            cp -r out/doc/*.pdf release_artifacts/
          fi
          
          # Copy generated Verilog from generated/ if present
          if [ -d "generated" ]; then
            find generated -name "*.v" -exec cp {} release_artifacts/ \;
          fi
          
          # Copy synthesized netlists from out/synth
          if [ -d "out/synth" ]; then
            find out/synth -name "*.v" -exec cp {} release_artifacts/ \;
          fi
          
          # Copy JSON and TEX result files
          if [ -d "out/results" ]; then
            cp -r out/results/* release_artifacts/ || true
          fi
          
          echo "Contents of release_artifacts:"
          ls -la release_artifacts
          
          tar -czvf release_artifacts.tar.gz release_artifacts/

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release_artifacts.tar.gz
            release_artifacts/*.pdf
            release_artifacts/*.v
            release_artifacts/*.json
            release_artifacts/*.tex
          tag_name: v${{ github.run_number }}
          name: Release ${{ github.run_number }}
          body: |
            Automated release from GitHub Actions

            This release includes:
            - Documentation (PDF)
            - Verilog files
            - Synthesized netlists
            - JSON and TEX result files
          draft: false
          prerelease: false
